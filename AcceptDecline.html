<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Employer - Manage Post / Applicants</title>

<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

<script>
tailwind.config = {
  darkMode: "class",
  theme: {
    extend: {
      colors: {
        primary: "#345395",
        accent: "#f95e07",
        success: "#208672",
        "background-light": "#f6f7f8",
        "background-dark": "#14171e",
      },
      fontFamily: {
        display: ["Plus Jakarta Sans", "sans-serif"]
      }
    }
  }
}
</script>

<style>
body {
  min-height: max(884px, 100dvh);
}
</style>
</head>

<body class="font-display bg-background-light">

<div class="relative flex min-h-screen w-full flex-col overflow-x-hidden">

<!-- Top Bar -->
<div class="sticky top-0 z-10 flex items-center p-4 justify-between bg-background-light border-b">
  <button onclick="location.href='employer_home.html'">
    <span class="material-symbols-outlined">arrow_back_ios_new</span>
  </button>
  <h2 class="text-lg font-bold">Manage Applicants</h2>
  <div class="w-6"></div>
</div>

<!-- MAIN -->
<main class="flex-grow pb-24" id="applicants">

<!-- ================= TEMPLATE CARD (ใช้เป็นต้นแบบ) ================= -->
<div class="p-4 pt-0 @container applicant-template">
  <div class="flex flex-col rounded-xl shadow bg-white">
    <div class="flex flex-col gap-4 p-4">

      <div class="flex items-start gap-4">
        <img class="h-14 w-14 rounded-full object-cover" src="https://via.placeholder.com/80"/>

        <div class="flex flex-col gap-1">
          <p class="text-primary text-lg font-bold">Full Name</p>
        </div>
      </div>

      <p class="text-gray-600 text-base">
        Bio here
      </p>
    </div>

    <div class="flex gap-3 p-4 pt-0">
      <button class="flex-1 h-12 bg-accent text-white rounded-lg font-bold">
        Decline
      </button>
      <button class="flex-1 h-12 bg-success text-white rounded-lg font-bold">
        Accept
      </button>
    </div>
  </div>
</div>
<!-- ================= END TEMPLATE ================= -->

</main>

</div>

<!-- ================= SUPABASE ================= -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://ispbevvwwggbktfczmui.supabase.co",
  "sb_publishable_5pnSaiKllm-q7UNMe5r7pw_n4Qu-AJ7"
);

// ดึง jobpost_id จาก URL
const params = new URLSearchParams(window.location.search);
const jobpostId = params.get("jobpost_id");

async function loadApplicants() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    location.href = "login.html";
    return;
  }

  const { data, error } = await supabase
  .from("job_applications")
  .select(`
    job_application_id,
    application_status,
    applied_at,
    job_seekers!inner (
      bio,
      profiles!inner (
        first_name,
        last_name,
        avatar_url
      )
    )
  `)
  .eq("jobpost_id", jobpostId)
  .order("applied_at", { ascending: false });


  if (error) {
    console.error(error);
    return;
  }

  renderApplicants(data);
}

function renderApplicants(applications) {
  const container = document.getElementById("applicants");
  const template = document.querySelector(".applicant-template");

  container.innerHTML = "";

  applications.forEach(app => {
    const card = template.cloneNode(true);
    card.classList.remove("applicant-template");

    const seeker = app.job_seekers;
const profile = seeker.profiles;

const fullName = `${profile.first_name} ${profile.last_name}`;
const avatar = profile.avatar_url || "https://via.placeholder.com/80";
const bio = seeker.bio || "-";


    // avatar
    card.querySelector("img").src =
      seeker.avatar_url || "https://via.placeholder.com/80";

    // name
    card.querySelector("p.text-primary").innerText =
      `${profile.first_name} ${profile.last_name}`;

    // bio
    card.querySelector("p.text-gray-600").innerText =
      seeker.bio || "-";

    // buttons
    const [declineBtn, acceptBtn] = card.querySelectorAll("button");

    declineBtn.onclick = () =>
      updateStatus(app.job_application_id, "Declined");

    acceptBtn.onclick = () =>
      updateStatus(app.job_application_id, "Accepted");

    container.appendChild(card);
  });
}

async function updateStatus(applicationId, status) {
  const { error } = await supabase
    .from("job_applications")
    .update({ application_status: status })
    .eq("job_application_id", applicationId);

  if (error) {
    alert("Update failed");
    console.error(error);
  } else {
    loadApplicants();
  }
}

loadApplicants();
</script>

</body>
</html>
