<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Work-i-Go Employer Home</title>

<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

<script>
tailwind.config = {
  darkMode: "class",
  theme: {
    extend: {
      colors: {
        primary: "#f95f06",
        "background-light": "#f8f6f5",
        "background-dark": "#23160f",
      },
      fontFamily: {
        display: ["Plus Jakarta Sans", "sans-serif"]
      }
    }
  }
}
</script>

<style>
.material-symbols-outlined {
  font-size: 24px;
}
body {
  min-height: max(884px, 100dvh);
}
</style>
</head>

<body class="bg-background-light font-display">
<div class="relative mx-auto min-h-screen w-full max-w-md bg-white overflow-x-hidden pb-24">

<!-- Top Bar -->
<div class="sticky top-0 z-10 flex items-center p-4 justify-between bg-white">
  <div class="w-12"></div>
  <h1 class="text-[#345395] text-lg font-bold flex-1 text-center">Work-i-Go</h1>
  <div class="w-12 text-right">
    <span class="material-symbols-outlined">chat_bubble</span>
  </div>
</div>

<!-- CONTENT -->
<div class="flex-grow overflow-y-auto">

<!-- Stats -->
<div class="flex gap-3 p-4">
  <div class="flex-1 bg-gray-50 p-4 rounded-xl border">
    <p class="text-sm text-gray-500">Approved Posts</p>
    <p id="approved-posts" class="text-3xl font-bold text-[#345395]">0</p>
  </div>
  <div class="flex-1 bg-gray-50 p-4 rounded-xl border">
    <p class="text-sm text-gray-500">Applicants</p>
    <p id="total-applicants" class="text-3xl font-bold text-[#345395]">0</p>
  </div>
</div>

<!-- CTA -->
<div class="px-4">
  <button onclick="location.href='employer_post_a_job_form.html'"
    class="w-full h-14 bg-primary text-white rounded-xl font-bold flex items-center justify-center gap-2">
    <span class="material-symbols-outlined">add_circle</span>
    Post a New Job
  </button>
</div>

<!-- Recent Applicants -->
<div class="px-4 pt-6 pb-2 flex justify-between">
  <h2 class="text-[22px] font-bold text-[#345395]">Recent Applicants</h2>
</div>
<div id="recent-applicants" class="px-4 space-y-2"></div>

<!-- My Job Posts -->
<div class="px-4 pt-8 pb-2 flex justify-between">
  <h2 class="text-[22px] font-bold text-[#345395]">My Job Posts</h2>
</div>
<div id="my-job-posts" class="px-4 space-y-2"></div>

</div>

<!-- Bottom Nav -->
<div class="fixed bottom-0 left-0 right-0 bg-white border-t">
  <div class="flex h-20 justify-around items-center">
    <span class="material-symbols-outlined text-primary">home</span>
    <span class="material-symbols-outlined">group</span>
    <span class="material-symbols-outlined">calendar_month</span>
    <span class="material-symbols-outlined">person</span>
  </div>
</div>

</div>

<!-- ================= SUPABASE ================= -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://ispbevvwwggbktfczmui.supabase.co",
  "sb_publishable_5pnSaiKllm-q7UNMe5r7pw_n4Qu-AJ7"
);

async function loadDashboard() {
  /* ================= AUTH ================= */
  const { data: { user }, error } = await supabase.auth.getUser();
  if (!user || error) {
    location.href = "login.html";
    return;
  }

  const employer_id = "EM_" + user.id;

  /* ================= JOB POSTS ================= */
  const { data: jobposts, error: jobErr } = await supabase
    .from("jobposts")
    .select("jobpost_id, job_title, approval_status")
    .eq("employer_id", employer_id)
    .order("created_at", { ascending: false });

  if (jobErr) {
    console.error(jobErr);
    return;
  }

  const jobpostIds = jobposts.map(j => j.jobpost_id);

  /* ================= APPLICATIONS ================= */
  let applications = [];

  if (jobpostIds.length > 0) {
    const { data, error } = await supabase
  .from("job_applications")
  .select(`
    job_application_id,
    jobpost_id,
    applied_at,
    job_seekers!inner (
      profiles!inner (
        first_name,
        last_name,
        avatar_url
      )
    )
  `)
  .in("jobpost_id", jobpostIds)
  .order("applied_at", { ascending: false });



    if (error) {
      console.error(error);
      return;
    }

    applications = data || [];
  }

  /* ================= STATS ================= */
  document.getElementById("approved-posts").innerText =
    jobposts.filter(j => j.approval_status === "Approved").length;

  document.getElementById("total-applicants").innerText =
    applications.length;

  /* ================= RECENT APPLICANTS ================= */
  const recentContainer = document.getElementById("recent-applicants");
  recentContainer.innerHTML = "";

  applications.slice(0, 5).forEach(app => {
    const job = jobposts.find(j => j.jobpost_id === app.jobpost_id);
    const profile = app.job_seekers?.profiles;

    const fullName = profile
      ? `${profile.first_name} ${profile.last_name}`
      : "Unknown";

    const avatar =
      profile?.avatar_url || "https://via.placeholder.com/48";

    recentContainer.innerHTML += `
      <div class="flex items-center gap-4 bg-gray-50 p-3 rounded-xl border">
        <div class="h-12 w-12 rounded-full bg-cover bg-center"
          style="background-image:url('${avatar}')"></div>

        <div class="flex-1">
          <p class="font-medium text-gray-900">${fullName}</p>
          <p class="text-sm text-gray-500">
            Applied for '${job?.job_title || "-"}'
          </p>
        </div>

        <button
          onclick="location.href='AcceptDecline.html?jobpost_id=${app.jobpost_id}'"
          class="text-primary font-bold">
          View
        </button>
      </div>
    `;
  });

  /* ================= MY JOB POSTS ================= */
  const jobContainer = document.getElementById("my-job-posts");
  jobContainer.innerHTML = "";

  jobposts.forEach(job => {
    const count = applications.filter(
      a => a.jobpost_id === job.jobpost_id
    ).length;

    let badge = "";
    if (job.approval_status === "Approved") {
      badge = `<span class="px-3 py-1 text-xs rounded-full bg-green-100 text-green-700">Approved</span>`;
    } else if (job.approval_status === "Pending") {
      badge = `<span class="px-3 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700">Pending</span>`;
    } else {
      badge = `<span class="px-3 py-1 text-xs rounded-full bg-red-100 text-red-600">Rejected</span>`;
    }

    jobContainer.innerHTML += `
      <div onclick="location.href='AcceptDecline.html?jobpost_id=${job.jobpost_id}'"
        class="flex items-center gap-4 bg-gray-50 p-4 rounded-xl border cursor-pointer">
        <div class="flex-1">
          <p class="font-medium">${job.job_title}</p>
          <p class="text-sm text-gray-500">${count} Applicants</p>
        </div>
        ${badge}
      </div>
    `;
  });
}

loadDashboard();

</script>



</body>
</html>
